import{EJSON as e,ObjectId as t}from"bson";var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},r(e,t)};function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var o=function(){return o=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},o.apply(this,arguments)};function i(e,t,r,n){return new(r||(r=Promise))((function(o,i){function c(e){try{s(n.next(e))}catch(e){i(e)}}function a(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(c,a)}s((n=n.apply(e,t||[])).next())}))}function c(e,t){var r,n,o,i,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(c=0)),c;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return c.label++,{value:a[1],done:!1};case 5:c.label++,n=a[1],a=[0];continue;case 7:a=c.ops.pop(),c.trys.pop();continue;default:if(!(o=c.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){c=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){c.label=a[1];break}if(6===a[0]&&c.label<o[1]){c.label=o[1],o=a;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(a);break}o[2]&&c.ops.pop(),c.trys.pop();continue}a=t.call(e,c)}catch(e){a=[6,e],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function a(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))}var s,l={common:{PRESERVER_ERROR:{errorCode:156401,errMsg:"不能将循环结构转换为JSON"},UNSET_FIELD_ERROR:{errorCode:156401,errMsg:"不能对未设置字段名的比较命令进行编码"}},serverDate:{SERVER_DATE_PARAM_ERROR:{errorCode:156401,errMsg:"serverDate值必须是一个整型"}},symobl:{SYMBOL_PARAM_ERROR:{errorCode:156401,errMsg:"InternalSymbol不能被新操作符实例化"}},collection:{COLLECTION_PARAM_ERROR:{errorCode:156401,errMsg:"集合名必填"},add:{ADD_PARAM_ERROR:{errorCode:156401,errMsg:"参数必须是对象"},ADD_PARAM_ID_ERROR:{errorCode:156401,errMsg:"_id必须是一个非空字符串"}},where:{WHERE_PARAM_OBJECT_ERROR:{errorCode:156401,errMsg:"查询参数必须为对象"},WHREE_PARAM_UNDEFINED_ERROR:{errorCode:156401,errMsg:"查询参数对象值不能均为undefined"}},"order-by":{ORDER_BY_FIELD_PATH_ERROR:{errorCode:156401,errMsg:"非法排序路径"},ORDER_BY_DIRECTION_ERROR:{errorCode:156401,errMsg:"排序字符不合法"}},limit:{LIMIT_PARAM_ERROR:{errorCode:156401,errMsg:"limit必须是一个整型"}},skip:{SKIP_PARAM_ERROR:{errorCode:156401,errMsg:"skip必须是一个整型"}},field:{FILED_PARAM_ERROR:{errorCode:156401,errMsg:"field参数对象值必须是一个对象，整型或者布尔值"}},update:{UPDATE_PARAM_ERROR:{errorCode:156401,errMsg:"参数必须是非空对象"},UPDATE_ID_ERROR:{errorCode:156401,errMsg:"_id值不能更新"}},remove:{REMOVE_PARAM_ERROR:{errorCode:156401,errMsg:"remove()操作不支持skip,limit,field,orderBy"}}},doc:{set:{SET_PARAM_ERROR:{errorCode:156401,errMsg:"docId必须为非空字符串"},SET_PARAM_OBJECT_ERROR:{errorCode:156401,errMsg:"参数必须是非空对象"},SET_PARAM_HAS_ID_ERROR:{errorCode:156401,errMsg:"_id值不能更新"}},update:{UPDATE_PARAM_ERROR:{errorCode:156401,errMsg:"docId必须为非空字符串"},UPDATE_PARAM_OBJECT_ERROR:{errorCode:156401,errMsg:"参数必须是非空对象"},UPDATE_PARAM_HAS_ID_ERROR:{errorCode:156401,errMsg:"_id值不能更新"}},get:{GET_PARAM_ERROR:{errorCode:156401,errMsg:"docId必须为非空字符串"}}}},u=function(e){function t(t){var r=e.call(this,t.errMsg)||this;return r.errorCode=0,r.errMsg="",Object.defineProperties(r,{message:{get:function(){return"errCode: ".concat(this.errorCode||""," | errMsg: ").concat(this.errMsg)}}}),r.errorCode=t.errorCode||0,r.errMsg=t.errMsg||"",r}return n(t,e),t}(Error),d=function(e,t){var r=new u.reqClass(u.dbConfig);(null==r?void 0:r.paramErrorReport)&&r.paramErrorReport(e.errMsg,t)},_=[],f={},R=function(e){function t(t,r){if(r!==f)throw new u(l.symobl.SYMBOL_PARAM_ERROR);return e.call(this,t)||this}return n(t,e),t.for=function(e){for(var r=0,n=_.length;r<n;r++)if(_[r].tar===e)return _[r].instance;var o=new t(e,f);return _.push({tar:e,instance:o}),o},t}((function(e){Object.defineProperties(this,{target:{enumerable:!1,writable:!1,configurable:!1,value:e}})})),p=R.for("UNSET_FIELD_NAME"),h=R.for("UPDATE_COMMAND"),O=R.for("QUERY_COMMAND"),v=R.for("LOGIC_COMMAND"),E=R.for("SERVER_DATE");!function(e){e.OR_COMMAND="or",e.NOR_COMMAND="nor",e.AND_COMMAND="and"}(s||(s={}));var A,M=function(){function e(e,t,r){if(this._internalType=v,this.handle=e,this.objects=t,this.name=r||p,this.name!==p)if("array"===Object.prototype.toString.call(t).slice(8,-1).toLowerCase()){t=a([],t,!0),this.objects=t;for(var n=0;n<t.length;n++){(m(o=t[n])||D(o))&&(t[n]=o._setName(this.name))}}else{var o;(m(o=t)||D(o))&&(t=o._setName(this.name))}}return e.prototype._setName=function(t){var r=this.objects.map((function(n){return n instanceof e?n._setName(t):r}));return new e(this.handle,r,t)},e.prototype.and=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=Array.isArray(t[0])?t[0]:t;return n=a([this],n,!0),new e(s.AND_COMMAND,n,this.name)},e.prototype.or=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=Array.isArray(t[0])?t[0]:t;return n=a([this],n,!0),new e(s.OR_COMMAND,n,this.name)},e}();function m(e){return e&&e instanceof M&&e._internalType===v}function D(e){return e&&e instanceof M&&e._internalType===O}!function(e){e.EQ_COMMAND="eq",e.NEQ_COMMAND="neq",e.GT_COMMAND="gt",e.GTE_COMMAND="gte",e.LT_COMMAND="lt",e.LTE_COMMAND="lte",e.IN_COMMAND="in",e.NIN_COMMAND="nin"}(A||(A={}));var y,b=function(e){function t(r,n,o){var i=e.call(this,r,n,o)||this;return i.eq=function(e){var r=new t(A.EQ_COMMAND,[e],i.name);return i.and(r)},i.handle=r,i._internalType=O,i}return n(t,e),t.prototype.toJSON=function(){var e,t;switch(this.handle){case A.IN_COMMAND:case A.NIN_COMMAND:return(e={})["$".concat(this.handle)]=this.objects,e;case A.NEQ_COMMAND:return{$ne:this.objects[0]};default:return(t={})["$".concat(this.handle)]=this.objects[0],t}},t.prototype._setName=function(e){return new t(this.handle,this.objects,e)},t.prototype.neq=function(e){var r=new t(A.NEQ_COMMAND,[e],this.name);return this.and(r)},t.prototype.gt=function(e){var r=new t(A.GT_COMMAND,[e],this.name);return this.and(r)},t.prototype.gte=function(e){var r=new t(A.GTE_COMMAND,[e],this.name);return this.and(r)},t.prototype.lt=function(e){var r=new t(A.LT_COMMAND,[e],this.name);return this.and(r)},t.prototype.lte=function(e){var r=new t(A.LTE_COMMAND,[e],this.name);return this.and(r)},t.prototype.in=function(e){var r=new t(A.IN_COMMAND,e,this.name);return this.and(r)},t.prototype.nin=function(e){var r=new t(A.NIN_COMMAND,e,this.name);return this.and(r)},t}(M);function w(e){return e&&e instanceof b&&e._internalType===O}!function(e){e.SET_COMMAND="set"}(y||(y={}));var C,g,N,P=function(e,t,r){this._internalType=h,Object.defineProperties(this,{_internalType:{enumerable:!1,configurable:!1}}),this.handle=e,this.objects=t,this.name=r||p},T="Date",I="Array",j="Object",q=["desc","asc"];!function(e){e.lt="<",e.gt=">",e.lte="<=",e.gte=">=",e.eq="=="}(g||(g={})),(C={})[g.lt]="$lt",C[g.lte]="$lte",C[g.eq]="$eq",C[g.gt]="$gt",C[g.gte]="$gte",function(e){e.DOC="DOC",e.WHERE="WHERE"}(N||(N={}));var S,L=["database.getDocument","database.calculateDocument","database.updateDocument","database.removeDocument","database.addDocument"];!function(e){e["database.getDocument"]="database.getDocument",e["database.calculateDocument"]="database.calculateDocument",e["database.updateDocument"]="database.updateDocument",e["database.removeDocument"]="database.removeDocument",e["database.addDocument"]="database.addDocument"}(S||(S={}));var U,F=["collection","collection.get","collection.count","collection.update","collection.remove","collection.add","collection.where","collection.order-by","collection.limit","collection.skip","collection.field","collection.doc","doc.get","doc.set","doc.update","doc.remove","serverDate"];!function(e){e.collection="collection",e["collection.get"]="collection.get",e["collection.count"]="collection.count",e["collection.update"]="collection.update",e["collection.remove"]="collection.remove",e["collection.add"]="collection.add",e["collection.where"]="collection.where",e["collection.order-by"]="collection.order-by",e["collection.limit"]="collection.limit",e["collection.skip"]="collection.skip",e["collection.field"]="collection.field",e["collection.doc"]="collection.doc",e["doc.get"]="doc.get",e["doc.set"]="doc.set",e["doc.update"]="doc.update",e["doc.remove"]="doc.remove",e.serverDate="serverDate"}(U||(U={}));var H=function(){function e(e){var t=(void 0===e?{}:e).offset,r=void 0===t?0:t;if(!Number.isInteger(r))throw d(l.serverDate.SERVER_DATE_PARAM_ERROR,U.serverDate),new u(l.serverDate.SERVER_DATE_PARAM_ERROR);this.offset=r}return e.resetHasServerDate=function(){this.isHasServerDate=!1},e.setHasServerDate=function(e){this.isHasServerDate=e},e.getServerDate=function(){return this.isHasServerDate},Object.defineProperty(e.prototype,"_internalType",{get:function(){return E},enumerable:!1,configurable:!0}),e.prototype.parse=function(){return e.setHasServerDate(!0),{$dyc_server_date:{offset:this.offset}}},e}();function k(e){return new H(e)}var Q={formatResDocumentData:function(e){return e.map((function(e){return Q.formatField(e)}))},formatField:function(e){var r=Object.keys(e),n={};Array.isArray(e)&&(n=[]);for(var o=0,i=r;o<i.length;o++){var c=i[o],a=e[c],s=void 0;switch(Q.whichType(a)){case T:s=a;break;case j:if("_id"===c&&t.isValid(a))try{s=a.toString()}catch(e){s=""}else s=Q.formatField(a);break;case I:s=Q.formatField(a);break;default:s=a}Array.isArray(n)?n.push(s):n[c]=s}return n},whichType:function(e){var t=Object.prototype.toString.call(e).slice(8,-1);return t===T?T:t}},B=function(e){if(!V(e))return e;for(var t in e)void 0===e[t]?delete e[t]:V(e[t])&&(e[t]=B(e[t]));return e},$=function(t){return t=B(t),e.stringify(t,{relaxed:!1})};function J(e,t){return e&&Object.prototype.hasOwnProperty.call(e,t)}function G(e){return H.getServerDate()&&(e.has_server_date=!0),H.resetHasServerDate(),e}var W=function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()},V=function(e){return"object"===W(e)},Y=function(e){return"string"===W(e)},x=function(e){return Array.isArray(e)},K=function(e){return"date"===W(e)},z=function(e){return e&&e._internalType instanceof R},X=function(e){var t=o({},e);for(var r in e){var n=e[r];if("boolean"==typeof n)t[r]=n?1:0;else if("number"==typeof n)t[r]=n>0?1:0;else{if(!V(n))throw d(l.collection.field.FILED_PARAM_ERROR,U["collection.field"]),new u(l.collection.field.FILED_PARAM_ERROR);var i=X(n);for(var c in i)t["".concat(r,".").concat(c)]=i[c];delete t[r]}}return t},Z={};for(var ee in s)Object.prototype.hasOwnProperty.call(s,ee)&&(Z[ee]="$"+ee);for(var ee in A)Object.prototype.hasOwnProperty.call(A,ee)&&(Z[ee]="$"+ee);for(var ee in y)Object.prototype.hasOwnProperty.call(y,ee)&&(Z[ee]="$"+ee);function te(e){return Z[e]||"$"+e}Z[A.NEQ_COMMAND]="$ne";var re={eq:function(e){return new b(A.EQ_COMMAND,[e])},neq:function(e){return new b(A.NEQ_COMMAND,[e])},lt:function(e){return new b(A.LT_COMMAND,[e])},lte:function(e){return new b(A.LTE_COMMAND,[e])},gt:function(e){return new b(A.GT_COMMAND,[e])},gte:function(e){return new b(A.GTE_COMMAND,[e])},in:function(e){return new b(A.IN_COMMAND,e)},nin:function(e){return new b(A.NIN_COMMAND,e)},and:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=x(e[0])?e[0]:e;return new M(s.AND_COMMAND,r)},nor:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=x(e[0])?e[0]:e;return new M(s.NOR_COMMAND,r)},or:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=x(e[0])?e[0]:e;return new M(s.OR_COMMAND,r)}},ne=function e(t,r){e.reqClass=t,u.reqClass=t,u.dbConfig=r,this.config=r,this.command=re,this.serverDate=k};function oe(e){return ie(e,[e])}function ie(e,t){if(z(e))return e._internalType===E?e.parse():e.toJSON?e.toJSON():e;if(K(e))return e;if(x(e))return e.map((function(e){if(t.includes(e))throw new u(l.common.PRESERVER_ERROR);return ie(e,a(a([],t,!0),[e],!1))}));if(V(e)){for(var r=o({},e),n={},i=0,c=Object.keys(r);i<c.length;i++){var s=c[i];if(t.includes(r[s]))throw new u(l.common.PRESERVER_ERROR);void 0!==r[s]&&(n[s]=ie(r[s],a(a([],t,!0),[r[s]],!1)))}return n}return e}function ce(e){return ae(e,se,[],[e])}function ae(e,t,r,n){var i=o({},e);for(var c in e)if(!/^\$/.test(c)){var s=e[c];if(void 0!==s){if(s&&V(s)&&!t(s)){if(n.includes(s))throw new u(l.common.PRESERVER_ERROR);var d=ae(s,t,a(a([],r,!0),[c],!1),a(a([],n,!0),[s],!1));i[c]=d;var _=!1;for(var f in d)/^\$/.test(f)?_=!0:(i["".concat(c,".").concat(f)]=d[f],delete i[c][f]);_||delete i[c]}}else delete i[c]}return i}function se(e){return z(e)||K(e)}function le(e){return oe(e)}var ue=function(){function e(){}return e.encodeEJSON=function(t){var r=new e;return $(r.encodeUpdate(t))},e.prototype.encodeUpdate=function(e){return this.encodeUpdateObject(e)},e.prototype.encodeUpdateObject=function(e){var t=ce(e);for(var r in t)if(!/^\$/.test(r)){var n=t[r];n=le(n),t[r]=n;var o=new P(y.SET_COMMAND,[n],r),i=this.encodeUpdateCommand(o);this.merge(t,i,r)}return t},e.prototype.encodeUpdateCommand=function(e){return this.encodeFieldUpdateCommand(e)},e.prototype.encodeFieldUpdateCommand=function(e){var t,r;return(t={})[te(e.handle)]=((r={})[e.name]=e.objects[0],r),t},e.prototype.merge=function(e,t,r){for(var n in t[r]||delete e[r],t)e[n]?x(e[n])?e[n].push(t[n]):V(e[n])&&V(t[n])?Object.assign(e[n],t[n]):e[n]=t[n]:e[n]=t[n]},e}(),de=function(){function t(e,t,r){this._db=e,this._coll=t,this.id=r,this._request=new ne.reqClass(this._db.config)}return t.prototype.get=function(){var t,r;return i(this,void 0,void 0,(function(){var n,o,i,a;return c(this,(function(c){switch(c.label){case 0:return n=$({_id:this.id}),o={collection_name:this._coll,query:n,query_type:N.DOC,multi:!1},[4,this._request.send(S["database.getDocument"],o,U["doc.get"])];case 1:return i=c.sent(),a=null===(t=null==i?void 0:i.list)||void 0===t?void 0:t.map((function(t){return console.log("item",t),console.log("parse 后的",e.parse(t)),e.parse(t)})),[2,{data:Q.formatResDocumentData(null!=a?a:[]),requestId:null!==(r=null==i?void 0:i.request_id)&&void 0!==r?r:""}]}}))}))},t.prototype.set=function(e){var t,r;return i(this,void 0,void 0,(function(){var n,o;return c(this,(function(i){switch(i.label){case 0:if(!Y(this.id)||""===this.id)throw d(l.doc.set.SET_PARAM_ERROR,U["doc.set"]),new u(l.doc.set.SET_PARAM_ERROR);if(!(e&&"object"===W(e)&&Object.keys(e).length>0))throw d(l.doc.set.SET_PARAM_OBJECT_ERROR,U["doc.set"]),new u(l.doc.set.SET_PARAM_OBJECT_ERROR);if(J(e,"_id"))throw d(l.doc.set.SET_PARAM_HAS_ID_ERROR,U["doc.set"]),new u(l.doc.set.SET_PARAM_HAS_ID_ERROR);return n={collection_name:this._coll,query_type:N.DOC,update_data:$(oe(e)),multi:!1,merge:!1,upsert:!0},this.id&&(n=Object.assign(n,{query:$({_id:this.id})})),[4,this._request.send(S["database.updateDocument"],G(n),U["doc.set"])];case 1:return o=i.sent(),[2,{updated:null!==(t=null==o?void 0:o.updated)&&void 0!==t?t:0,requestId:null!==(r=null==o?void 0:o.request_id)&&void 0!==r?r:""}]}}))}))},t.prototype.update=function(e){var t,r;return i(this,void 0,void 0,(function(){var n,o;return c(this,(function(i){switch(i.label){case 0:if(!Y(this.id)||""===this.id)throw d(l.doc.update.UPDATE_PARAM_ERROR,U["doc.update"]),new u(l.doc.update.UPDATE_PARAM_ERROR);if(!(e&&"object"===W(e)&&Object.keys(e).length>0))throw d(l.doc.update.UPDATE_PARAM_OBJECT_ERROR,U["doc.update"]),new u(l.doc.update.UPDATE_PARAM_OBJECT_ERROR);if(J(e,"_id"))throw d(l.doc.update.UPDATE_PARAM_HAS_ID_ERROR,U["doc.update"]),new u(l.doc.update.UPDATE_PARAM_HAS_ID_ERROR);return n={collection_name:this._coll,update_data:ue.encodeEJSON(e),query_type:N.DOC,multi:!1,merge:!0,upsert:!1},this.id&&(n=Object.assign(n,{query:$({_id:this.id})})),[4,this._request.send(S["database.updateDocument"],G(n),U["doc.update"])];case 1:return o=i.sent(),[2,{updated:null!==(t=null==o?void 0:o.updated)&&void 0!==t?t:0,requestId:null!==(r=null==o?void 0:o.request_id)&&void 0!==r?r:""}]}}))}))},t.prototype.remove=function(){var e,t;return i(this,void 0,void 0,(function(){var r,n,o;return c(this,(function(i){switch(i.label){case 0:return r=$({_id:this.id}),n={collection_name:this._coll,query:r,query_type:N.DOC,multi:!1},[4,this._request.send(S["database.removeDocument"],n,U["doc.remove"])];case 1:return o=i.sent(),[2,{deleted:null!==(e=o.deleted)&&void 0!==e?e:0,requestId:null!==(t=o.request_id)&&void 0!==t?t:""}]}}))}))},t}(),_e=function(e){var t=new fe;return $(t.encodeQuery(e))},fe=function(){function e(){}return e.prototype.encodeQuery=function(e,t){if(se(e)){if(w(e))return this.encodeQueryCommand(e);if(m(e))return this.encodeLogicCommand(e)}return V(e)?this.encodeQueryObject(e):e},e.prototype.encodeLogicCommand=function(e){var t,r,n,o=this;switch(e.handle){case s.NOR_COMMAND:case s.AND_COMMAND:case s.OR_COMMAND:var i=te(e.handle),c=e.objects.map((function(t){return o.encodeQuery(t,e.name)}));return(t={})[i]=c,t;default:i=te(e.handle);if(1===e.objects.length){c=this.encodeQuery(e.objects[0]);return(r={})[i]=c,r}var a=e.objects.map(this.encodeQuery.bind(this));return(n={})[i]=a,n}},e.prototype.encodeQueryCommand=function(e){return this.encodeComparisonCommand(e)},e.prototype.encodeComparisonCommand=function(e){var t,r,n,o,i,c;if(e.name===p)throw new u(l.common.UNSET_FIELD_ERROR);var a=te(e.handle);switch(e.handle){case A.EQ_COMMAND:case A.NEQ_COMMAND:case A.LT_COMMAND:case A.LTE_COMMAND:case A.GT_COMMAND:case A.GTE_COMMAND:return(t={})[e.name]=((r={})[a]=le(e.objects[0]),r),t;case A.IN_COMMAND:case A.NIN_COMMAND:return(n={})[e.name]=((o={})[a]=le(e.objects),o),n;default:return(i={})[e.name]=((c={})[a]=le(e.objects[0]),c),i}},e.prototype.encodeQueryObject=function(e){for(var t=ce(e),r=0,n=Object.keys(t);r<n.length;r++){var o=n[r],i=t[o];if(m(i)){t[o]=i._setName(o);var c=this.encodeLogicCommand(t[o]);this.merge(t,c,o)}else if(w(i)){t[o]=i._setName(o);c=this.encodeComparisonCommand(t[o]);this.merge(t,c,o)}else se(i)&&(t[o]=le(i))}return t},e.prototype.merge=function(e,t,r){for(var n in t[r]||delete e[r],t)e[n]?x(e[n])?e[n]=e[n].concat(t[n]):V(e[n])&&V(t[n])?Object.assign(e,t):e[n]=t[n]:e[n]=t[n]},e}(),Re=function(){function t(e,t,r,n){this._db=e,this._coll=t,this._fieldFilters=r,this._apiOptions=n||{},this._request=new ne.reqClass(this._db.config)}return t.prototype.where=function(e){if(!V(e))throw d(l.collection.where.WHERE_PARAM_OBJECT_ERROR,U["collection.where"]),new u(l.collection.where.WHERE_PARAM_OBJECT_ERROR);var r=Object.keys(e),n=r.some((function(t){return void 0!==e[t]}));if(r.length>0&&!n)throw d(l.collection.where.WHREE_PARAM_UNDEFINED_ERROR,U["collection.where"]),new u(l.collection.where.WHREE_PARAM_UNDEFINED_ERROR);return new t(this._db,this._coll,_e(e),o({},this._apiOptions))},t.prototype.orderBy=function(e,r){var n;if(!/^[\w.-]/.test(e))throw d(l.collection["order-by"].ORDER_BY_FIELD_PATH_ERROR,U["collection.order-by"]),new u(l.collection["order-by"].ORDER_BY_FIELD_PATH_ERROR);if(!q.includes(r))throw d(l.collection["order-by"].ORDER_BY_DIRECTION_ERROR,U["collection.order-by"]),new u(l.collection["order-by"].ORDER_BY_DIRECTION_ERROR);var o=((n={})[e]="desc"===r?-1:1,n),i=this._apiOptions.order||{},c=Object.assign({},this._apiOptions,{order:Object.assign({},i,o)});return new t(this._db,this._coll,this._fieldFilters,c)},t.prototype.limit=function(e){if(!Number.isInteger(e))throw d(l.collection.limit.LIMIT_PARAM_ERROR,U["collection.limit"]),new u(l.collection.limit.LIMIT_PARAM_ERROR);var r=o({},this._apiOptions);return r.limit=e,new t(this._db,this._coll,this._fieldFilters,r)},t.prototype.skip=function(e){if(!Number.isInteger(e))throw d(l.collection.skip.SKIP_PARAM_ERROR,U["collection.skip"]),new u(l.collection.skip.SKIP_PARAM_ERROR);var r=o({},this._apiOptions);return r.offset=e,new t(this._db,this._coll,this._fieldFilters,r)},t.prototype.field=function(e){var r=X(e),n=o({},this._apiOptions);return n.projection=r,new t(this._db,this._coll,this._fieldFilters,n)},t.prototype.get=function(){var t,r;return i(this,void 0,void 0,(function(){var n,o,i,a,s,l,u;return c(this,(function(c){switch(c.label){case 0:return n=this._apiOptions.order,o={collection_name:this._coll,query_type:N.WHERE},this._fieldFilters&&(o.query=this._fieldFilters),n&&(o.order=$(n)),i=this._apiOptions.offset,o.offset=i||0,a=this._apiOptions.limit,o.limit=a,(s=this._apiOptions.projection)&&(o.projection=$(s)),[4,this._request.send(S["database.getDocument"],G(o),U["collection.get"])];case 1:return l=c.sent(),u=null===(t=null==l?void 0:l.list)||void 0===t?void 0:t.map((function(t){return e.parse(t)})),[2,{data:Q.formatResDocumentData(null!=u?u:[]),requestId:null!==(r=l.request_id)&&void 0!==r?r:""}]}}))}))},t.prototype.count=function(){var e;return i(this,void 0,void 0,(function(){var t,r;return c(this,(function(n){switch(n.label){case 0:return t={collection_name:this._coll,query_type:N.WHERE},this._fieldFilters&&(t.query=this._fieldFilters),[4,this._request.send(S["database.calculateDocument"],G(t),U["collection.count"])];case 1:return r=n.sent(),[2,{total:null!==(e=null==r?void 0:r.total)&&void 0!==e?e:0,requestId:(null==r?void 0:r.request_id)||""}]}}))}))},t.prototype.update=function(e){var t,r;return i(this,void 0,void 0,(function(){var n,o;return c(this,(function(i){switch(i.label){case 0:if(!(e&&"object"===W(e)&&Object.keys(e).length>0))throw d(l.collection.update.UPDATE_PARAM_ERROR,U["collection.update"]),new u(l.collection.update.UPDATE_PARAM_ERROR);if(J(e,"_id"))throw d(l.collection.update.UPDATE_ID_ERROR,U["collection.update"]),new u(l.collection.update.UPDATE_ID_ERROR);return n={collection_name:this._coll,query_type:N.WHERE,multi:!0,merge:!0,upsert:!1,update_data:ue.encodeEJSON(e)},this._fieldFilters&&(n=Object.assign(n,{query:this._fieldFilters})),[4,this._request.send(S["database.updateDocument"],G(n),U["collection.update"])];case 1:return o=i.sent(),[2,{updated:null!==(t=null==o?void 0:o.updated)&&void 0!==t?t:0,requestId:null!==(r=null==o?void 0:o.request_id)&&void 0!==r?r:""}]}}))}))},t.prototype.remove=function(){var e,t;return i(this,void 0,void 0,(function(){var r,n,o,i,a,s,d;return c(this,(function(c){switch(c.label){case 0:if(r=this._apiOptions,n=r.offset,o=r.limit,i=r.projection,a=r.order,void 0!==n||void 0!==o||void 0!==i||void 0!==a)throw new u(l.collection.remove.REMOVE_PARAM_ERROR);return s={collection_name:this._coll,query:this._fieldFilters,query_type:N.WHERE,multi:!0},[4,this._request.send(S["database.removeDocument"],G(s),U["collection.remove"])];case 1:return d=c.sent(),[2,{deleted:null!==(e=null==d?void 0:d.deleted)&&void 0!==e?e:0,requestId:null!==(t=null==d?void 0:d.request_id)&&void 0!==t?t:""}]}}))}))},t}(),pe=function(e){function t(t,r,n){var o=e.call(this,t,r,"",n)||this;return H.resetHasServerDate(),o}return n(t,e),t.prototype.getName=function(){return this._coll},t.prototype.doc=function(e){if("string"!=typeof e||""===e)throw d(l.doc.get.GET_PARAM_ERROR,U["collection.doc"]),new u(l.doc.get.GET_PARAM_ERROR);return new de(this._db,this._coll,e)},t.prototype.add=function(e){var t,r;return i(this,void 0,void 0,(function(){var n,o,i;return c(this,(function(c){switch(c.label){case 0:if(n=e,"object"!==W(e))throw d(l.collection.add.ADD_PARAM_ERROR,U["collection.add"]),new u(l.collection.add.ADD_PARAM_ERROR);if(J(e,"_id")&&(!Y(e._id)||""===e._id))throw d(l.collection.add.ADD_PARAM_ID_ERROR,U["collection.add"]),new u(l.collection.add.ADD_PARAM_ID_ERROR);return n=(n=[e]).map((function(e){return $(oe(e))})),o={collection_name:this._coll,insert_data:n},[4,this._request.send(S["database.addDocument"],G(o),U["collection.add"])];case 1:return i=c.sent(),[2,{id:(null===(t=null==i?void 0:i.inserted_ids)||void 0===t?void 0:t.length)>0?null==i?void 0:i.inserted_ids[0]:"",requestId:null!==(r=null==i?void 0:i.request_id)&&void 0!==r?r:""}]}}))}))},t}(Re),he=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.collection=function(e){if(!e)throw d(l.collection.COLLECTION_PARAM_ERROR,U.collection),new u(l.collection.COLLECTION_PARAM_ERROR);return new pe(this,e)},t}(ne);export{u as DataBaseError,he as Db,L as databaseAPIActions,F as databaseMethods};
