const a38_0x1e817d=a38_0x4a56;(function(_0x16a061,_0x30f6d2){const _0x497e1b=a38_0x4a56,_0x15c93b=_0x16a061();while(!![]){try{const _0x27131a=parseInt(_0x497e1b(0x159))/0x1+parseInt(_0x497e1b(0x16c))/0x2*(-parseInt(_0x497e1b(0x158))/0x3)+parseInt(_0x497e1b(0x177))/0x4*(-parseInt(_0x497e1b(0x161))/0x5)+parseInt(_0x497e1b(0x181))/0x6*(parseInt(_0x497e1b(0x154))/0x7)+parseInt(_0x497e1b(0x16b))/0x8*(-parseInt(_0x497e1b(0x150))/0x9)+parseInt(_0x497e1b(0x18e))/0xa+parseInt(_0x497e1b(0x15d))/0xb;if(_0x27131a===_0x30f6d2)break;else _0x15c93b['push'](_0x15c93b['shift']());}catch(_0x41715b){_0x15c93b['push'](_0x15c93b['shift']());}}}(a38_0x2768,0x8d71d));import{EJSON}from'bson';function a38_0x4a56(_0x3843b4,_0x5672fc){const _0x2768b5=a38_0x2768();return a38_0x4a56=function(_0x4a56af,_0x47ce70){_0x4a56af=_0x4a56af-0x14f;let _0x18b76f=_0x2768b5[_0x4a56af];return _0x18b76f;},a38_0x4a56(_0x3843b4,_0x5672fc);}import{baseDb}from'./basedb';import{OrderDirectionList,QueryType}from'./constant';import{DataBaseError,ErrorMsg,ERRORS}from'./Errors';function a38_0x2768(){const _0x87af76=['ORDER_BY_FIELD_PATH_ERROR','total','send','WHREE_PARAM_UNDEFINED_ERROR','_coll','config','8cseKYJ','254RftWHg','LIMIT_PARAM_ERROR','remove','number','database.updateDocument','projection','updated','WHERE_PARAM_OBJECT_ERROR','ORDER_BY_DIRECTION_ERROR','list','boolean','4WWOrVG','_db','order','get','limit','assign','length','_fieldFilters','call','WHERE','174WtCXyF','update','deleted','desc','order-by','prototype','parse','collection','_apiOptions','skip','count','_request','keys','3180210yQNUpX','UPDATE_PARAM_ERROR','REMOVE_PARAM_ERROR','query','test','toString','9519219WHqJbB','offset','where','database.getDocument','143395BKXydR','includes','slice','_id','15735vwhyJd','797612lLsjXS','orderBy','encodeEJSON','map','14231492bGHsUy','database.removeDocument','isInteger','some','3501535OESePF','request_id','SKIP_PARAM_ERROR','INVALID_PARAM'];a38_0x2768=function(){return _0x87af76;};return a38_0x2768();}import{QuerySerializer}from'./serializer/query';import{UpdateSerializer}from'./serializer/update';import{Util}from'./util';import{formatRequestServerDateParams,hasOwnProperty,stringifyByEJSON}from'./util';export class Query{constructor(_0x347cd8,_0x4a6546,_0x29d342,_0x52005d){const _0x385913=a38_0x4a56;this[_0x385913(0x178)]=_0x347cd8,this['_coll']=_0x4a6546,this['_fieldFilters']=_0x29d342,this[_0x385913(0x189)]=_0x52005d||{},this[_0x385913(0x18c)]=new baseDb['reqClass'](this[_0x385913(0x178)][_0x385913(0x16a)]);}[a38_0x1e817d(0x152)](_0x262657){const _0xe01d9f=a38_0x1e817d;if(Object[_0xe01d9f(0x186)][_0xe01d9f(0x14f)][_0xe01d9f(0x17f)](_0x262657)['slice'](0x8,-0x1)!=='Object')throw new DataBaseError(Object[_0xe01d9f(0x17c)](Object[_0xe01d9f(0x17c)]({},ERRORS[_0xe01d9f(0x164)]),{'errMsg':ErrorMsg[_0xe01d9f(0x188)][_0xe01d9f(0x152)][_0xe01d9f(0x173)]}));const _0x124c63=Object[_0xe01d9f(0x18d)](_0x262657),_0x3fa8d0=_0x124c63[_0xe01d9f(0x160)](_0x1c8449=>_0x262657[_0x1c8449]!==undefined);if(_0x124c63[_0xe01d9f(0x17d)]>0x0&&!_0x3fa8d0)throw new DataBaseError(Object[_0xe01d9f(0x17c)](Object[_0xe01d9f(0x17c)]({},ERRORS[_0xe01d9f(0x164)]),{'errMsg':ErrorMsg[_0xe01d9f(0x188)]['where'][_0xe01d9f(0x168)]}));return new Query(this['_db'],this[_0xe01d9f(0x169)],QuerySerializer[_0xe01d9f(0x15b)](_0x262657),Object[_0xe01d9f(0x17c)]({},this[_0xe01d9f(0x189)]));}[a38_0x1e817d(0x15a)](_0x1e0ded,_0x34df5d){const _0x1fcbee=a38_0x1e817d;if(!/^[\w.-]/[_0x1fcbee(0x192)](_0x1e0ded))throw new DataBaseError(Object['assign'](Object['assign']({},ERRORS['INVALID_PARAM']),{'errMsg':ErrorMsg[_0x1fcbee(0x188)][_0x1fcbee(0x185)][_0x1fcbee(0x165)]}));if(!OrderDirectionList[_0x1fcbee(0x155)](_0x34df5d))throw new DataBaseError(Object['assign'](Object[_0x1fcbee(0x17c)]({},ERRORS[_0x1fcbee(0x164)]),{'errMsg':ErrorMsg[_0x1fcbee(0x188)][_0x1fcbee(0x185)][_0x1fcbee(0x174)]}));const _0x4c104e={[_0x1e0ded]:_0x34df5d===_0x1fcbee(0x184)?-0x1:0x1},_0x415a16=this[_0x1fcbee(0x189)]['order']||{},_0x195b91=Object['assign']({},this[_0x1fcbee(0x189)],{'order':Object[_0x1fcbee(0x17c)]({},_0x415a16,_0x4c104e)});return new Query(this[_0x1fcbee(0x178)],this['_coll'],this[_0x1fcbee(0x17e)],_0x195b91);}[a38_0x1e817d(0x17b)](_0xe243f9){const _0x175573=a38_0x1e817d;if(!Number[_0x175573(0x15f)](_0xe243f9))throw new DataBaseError(Object[_0x175573(0x17c)](Object[_0x175573(0x17c)]({},ERRORS['INVALID_PARAM']),{'errMsg':ErrorMsg['collection']['limit'][_0x175573(0x16d)]}));const _0x1608a5=Object[_0x175573(0x17c)]({},this[_0x175573(0x189)]);return _0x1608a5[_0x175573(0x17b)]=_0xe243f9,new Query(this['_db'],this[_0x175573(0x169)],this['_fieldFilters'],_0x1608a5);}[a38_0x1e817d(0x18a)](_0x8038ea){const _0x1f3cd6=a38_0x1e817d;if(!Number[_0x1f3cd6(0x15f)](_0x8038ea))throw new DataBaseError(Object[_0x1f3cd6(0x17c)](Object[_0x1f3cd6(0x17c)]({},ERRORS[_0x1f3cd6(0x164)]),{'errMsg':ErrorMsg[_0x1f3cd6(0x188)]['skip'][_0x1f3cd6(0x163)]}));const _0x5bb45d=Object[_0x1f3cd6(0x17c)]({},this[_0x1f3cd6(0x189)]);return _0x5bb45d[_0x1f3cd6(0x151)]=_0x8038ea,new Query(this[_0x1f3cd6(0x178)],this[_0x1f3cd6(0x169)],this[_0x1f3cd6(0x17e)],_0x5bb45d);}['field'](_0x43a953){const _0x31b94d=a38_0x1e817d,_0x5e5fc1={};for(const _0x578f41 of Object[_0x31b94d(0x18d)](_0x43a953)){typeof _0x43a953[_0x578f41]===_0x31b94d(0x176)&&(_0x5e5fc1[_0x578f41]=_0x43a953[_0x578f41]===!![]?0x1:0x0),typeof _0x43a953[_0x578f41]===_0x31b94d(0x16f)&&(_0x5e5fc1[_0x578f41]=_0x43a953[_0x578f41]>0x0?0x1:0x0),typeof _0x43a953[_0x578f41]==='object'&&(_0x5e5fc1[_0x578f41]=_0x43a953[_0x578f41]);}const _0x350be8=Object[_0x31b94d(0x17c)]({},this[_0x31b94d(0x189)]);return _0x350be8['projection']=_0x5e5fc1,new Query(this['_db'],this[_0x31b94d(0x169)],this['_fieldFilters'],_0x350be8);}async[a38_0x1e817d(0x17a)](){const _0x546a9c=a38_0x1e817d;var _0x222005,_0x3057b2;const {order:_0x54f96c}=this['_apiOptions'],_0x18852c={'collection_name':this[_0x546a9c(0x169)],'query_type':QueryType[_0x546a9c(0x180)]};this[_0x546a9c(0x17e)]&&(_0x18852c[_0x546a9c(0x191)]=this[_0x546a9c(0x17e)]);_0x54f96c&&(_0x18852c[_0x546a9c(0x179)]=stringifyByEJSON(_0x54f96c));const {offset:_0x56d1cc}=this['_apiOptions'];_0x18852c['offset']=_0x56d1cc?_0x56d1cc:0x0;const {limit:_0x1747e5}=this['_apiOptions'];_0x18852c['limit']=_0x1747e5?_0x1747e5:0x64;const {projection:_0x3ed73a}=this['_apiOptions'];_0x3ed73a&&(_0x18852c[_0x546a9c(0x171)]=stringifyByEJSON(_0x3ed73a));const _0xfa251c=await this['_request'][_0x546a9c(0x167)](_0x546a9c(0x153),formatRequestServerDateParams(_0x18852c)),_0x4158a1=(_0x222005=_0xfa251c===null||_0xfa251c===void 0x0?void 0x0:_0xfa251c[_0x546a9c(0x175)])===null||_0x222005===void 0x0?void 0x0:_0x222005[_0x546a9c(0x15c)](_0x3ff234=>EJSON[_0x546a9c(0x187)](_0x3ff234)),_0x4280d8=Util['formatResDocumentData'](_0x4158a1!==null&&_0x4158a1!==void 0x0?_0x4158a1:[]);return{'data':_0x4280d8,'requestId':(_0x3057b2=_0xfa251c['request_id'])!==null&&_0x3057b2!==void 0x0?_0x3057b2:''};}async[a38_0x1e817d(0x18b)](){const _0x4f4f4f=a38_0x1e817d,_0x80787f={'collection_name':this[_0x4f4f4f(0x169)],'query_type':QueryType[_0x4f4f4f(0x180)]};this[_0x4f4f4f(0x17e)]&&(_0x80787f[_0x4f4f4f(0x191)]=this['_fieldFilters']);const _0x12f684=await this[_0x4f4f4f(0x18c)][_0x4f4f4f(0x167)]('database.calculateDocument',formatRequestServerDateParams(_0x80787f));return{'total':_0x12f684[_0x4f4f4f(0x166)],'requestId':_0x12f684[_0x4f4f4f(0x162)]};}async[a38_0x1e817d(0x182)](_0x268648){const _0x495f4b=a38_0x1e817d;var _0x48c028,_0x2af9d6;if(!(_0x268648&&Object['prototype'][_0x495f4b(0x14f)][_0x495f4b(0x17f)](_0x268648)[_0x495f4b(0x156)](0x8,-0x1)!=='Object'&&Object[_0x495f4b(0x18d)](_0x268648)[_0x495f4b(0x17d)]>0x0))throw new DataBaseError(Object[_0x495f4b(0x17c)](Object[_0x495f4b(0x17c)]({},ERRORS[_0x495f4b(0x164)]),{'errMsg':ErrorMsg['collection'][_0x495f4b(0x182)][_0x495f4b(0x18f)]}));if(hasOwnProperty(_0x268648,_0x495f4b(0x157)))throw new DataBaseError(Object[_0x495f4b(0x17c)](Object['assign']({},ERRORS[_0x495f4b(0x164)]),{'errMsg':ErrorMsg[_0x495f4b(0x188)][_0x495f4b(0x182)]['UPDATE_ID_ERROR']}));const _0x40db3a={'collection_name':this[_0x495f4b(0x169)],'query_type':QueryType[_0x495f4b(0x180)],'multi':!![],'merge':!![],'upsert':![],'update_data':UpdateSerializer[_0x495f4b(0x15b)](_0x268648)};this[_0x495f4b(0x17e)]&&(_0x40db3a[_0x495f4b(0x191)]=this[_0x495f4b(0x17e)]);const _0x987a93=await this[_0x495f4b(0x18c)][_0x495f4b(0x167)](_0x495f4b(0x170),formatRequestServerDateParams(_0x40db3a));return{'updated':(_0x48c028=_0x987a93[_0x495f4b(0x172)])!==null&&_0x48c028!==void 0x0?_0x48c028:0x0,'requestId':(_0x2af9d6=_0x987a93[_0x495f4b(0x162)])!==null&&_0x2af9d6!==void 0x0?_0x2af9d6:''};}async[a38_0x1e817d(0x16e)](){const _0x440636=a38_0x1e817d;var _0x293866,_0x280f21;const {offset:_0x2f1232,limit:_0x2cbec9,projection:_0x261116,order:_0x2a5725}=this[_0x440636(0x189)];if(_0x2f1232!==undefined||_0x2cbec9!==undefined||_0x261116!==undefined||_0x2a5725!==undefined)throw new DataBaseError(Object[_0x440636(0x17c)](Object[_0x440636(0x17c)]({},ERRORS[_0x440636(0x164)]),{'errMsg':ErrorMsg['collection']['remove'][_0x440636(0x190)]}));const _0x51a566={'collection_name':this[_0x440636(0x169)],'query':this[_0x440636(0x17e)],'query_type':QueryType[_0x440636(0x180)],'multi':!![]},_0x158f53=await this[_0x440636(0x18c)]['send'](_0x440636(0x15e),formatRequestServerDateParams(_0x51a566));return{'deleted':(_0x293866=_0x158f53===null||_0x158f53===void 0x0?void 0x0:_0x158f53[_0x440636(0x183)])!==null&&_0x293866!==void 0x0?_0x293866:0x0,'requestId':(_0x280f21=_0x158f53===null||_0x158f53===void 0x0?void 0x0:_0x158f53[_0x440636(0x162)])!==null&&_0x280f21!==void 0x0?_0x280f21:''};}}